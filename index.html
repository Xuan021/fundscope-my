<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FundScope MY â€” Public Mutual Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e13;
    --bg2: #0f1520;
    --bg3: #151d2b;
    --border: rgba(255,255,255,0.07);
    --accent: #00d4aa;
    --accent2: #f7a325;
    --red: #ff4d6d;
    --green: #00d4aa;
    --blue: #4dabf7;
    --text: #e8edf4;
    --text2: #8a96a8;
    --text3: #4a5568;
    --card: #111827;
    --mono: 'DM Mono', monospace;
    --serif: 'Playfair Display', serif;
    --sans: 'DM Sans', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    font-size: 14px;
    line-height: 1.6;
  }

  /* ANIMATED GRID BACKGROUND */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      linear-gradient(rgba(0,212,170,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,212,170,0.03) 1px, transparent 1px);
    background-size: 50px 50px;
    pointer-events: none;
    z-index: 0;
  }

  /* HEADER */
  .header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(10,14,19,0.92);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding: 0 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 64px;
  }

  .logo {
    display: flex;
    align-items: baseline;
    gap: 8px;
  }

  .logo-main {
    font-family: var(--serif);
    font-size: 22px;
    font-weight: 900;
    color: var(--accent);
    letter-spacing: -0.5px;
  }

  .logo-sub {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text2);
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .live-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: var(--mono);
    font-size: 11px;
    color: var(--accent);
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .live-dot {
    width: 7px; height: 7px;
    background: var(--accent);
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.4; transform: scale(0.8); }
  }

  .last-updated {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text3);
  }

  /* MAIN LAYOUT */
  .main {
    position: relative;
    z-index: 1;
    max-width: 1400px;
    margin: 0 auto;
    padding: 32px 24px;
  }

  /* HERO SECTION */
  .hero {
    margin-bottom: 40px;
    animation: fadeUp 0.6s ease both;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .hero h1 {
    font-family: var(--serif);
    font-size: clamp(28px, 4vw, 44px);
    font-weight: 900;
    line-height: 1.1;
    margin-bottom: 8px;
  }

  .hero h1 span { color: var(--accent); }

  .hero p {
    color: var(--text2);
    font-size: 15px;
    max-width: 600px;
  }

  /* SUMMARY STRIP */
  .summary-strip {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 36px;
    animation: fadeUp 0.6s 0.1s ease both;
  }

  .stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s;
  }

  .stat-card:hover { border-color: rgba(0,212,170,0.3); }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
  }
  .stat-card.green::before { background: var(--green); }
  .stat-card.red::before { background: var(--red); }
  .stat-card.blue::before { background: var(--blue); }
  .stat-card.orange::before { background: var(--accent2); }

  .stat-label {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 8px;
  }

  .stat-value {
    font-family: var(--serif);
    font-size: 28px;
    font-weight: 900;
    color: var(--text);
    line-height: 1;
  }

  .stat-sub {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text2);
    margin-top: 4px;
  }

  /* SECTION HEADERS */
  .section-title {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
  }

  .section-title h2 {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 2px;
    font-weight: 500;
  }

  .section-title .accent-line {
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* TABS */
  .tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 20px;
    background: var(--bg2);
    padding: 4px;
    border-radius: 10px;
    border: 1px solid var(--border);
    width: fit-content;
  }

  .tab {
    padding: 7px 16px;
    border-radius: 7px;
    font-family: var(--mono);
    font-size: 12px;
    font-weight: 500;
    color: var(--text2);
    cursor: pointer;
    border: none;
    background: none;
    transition: all 0.2s;
    letter-spacing: 0.5px;
  }

  .tab.active {
    background: var(--bg3);
    color: var(--accent);
    border: 1px solid rgba(0,212,170,0.2);
  }

  /* FUND TABLE */
  .table-container {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
    animation: fadeUp 0.6s 0.2s ease both;
  }

  .fund-table {
    width: 100%;
    border-collapse: collapse;
  }

  .fund-table thead th {
    padding: 14px 16px;
    text-align: left;
    font-family: var(--mono);
    font-size: 10px;
    font-weight: 500;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    border-bottom: 1px solid var(--border);
    background: var(--bg2);
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
    transition: color 0.2s;
  }

  .fund-table thead th:hover { color: var(--accent); }

  .fund-table tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
    cursor: pointer;
  }

  .fund-table tbody tr:hover { background: rgba(255,255,255,0.025); }
  .fund-table tbody tr:last-child { border-bottom: none; }

  .fund-table td {
    padding: 13px 16px;
    font-size: 13px;
    white-space: nowrap;
  }

  .rank-badge {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text3);
    width: 24px;
    text-align: center;
  }
  .rank-badge.top3 { color: var(--accent2); font-weight: 600; }

  .fund-name-cell { max-width: 240px; }
  .fund-name { font-weight: 500; color: var(--text); font-size: 13px; }
  .fund-code { font-family: var(--mono); font-size: 10px; color: var(--text3); margin-top: 2px; }

  .nav-value {
    font-family: var(--mono);
    font-size: 13px;
    color: var(--text);
    font-weight: 500;
  }

  .pct-cell {
    font-family: var(--mono);
    font-size: 12px;
    font-weight: 500;
    text-align: right;
  }
  .pct-cell.pos { color: var(--green); }
  .pct-cell.neg { color: var(--red); }
  .pct-cell.neu { color: var(--text3); }

  /* RSI PILL */
  .rsi-pill {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 8px;
    border-radius: 20px;
    font-family: var(--mono);
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }
  .rsi-pill.overbought { background: rgba(255,77,109,0.15); color: var(--red); border: 1px solid rgba(255,77,109,0.3); }
  .rsi-pill.oversold   { background: rgba(0,212,170,0.15);  color: var(--green); border: 1px solid rgba(0,212,170,0.3); }
  .rsi-pill.bullish    { background: rgba(77,171,247,0.15); color: var(--blue); border: 1px solid rgba(77,171,247,0.3); }
  .rsi-pill.bearish    { background: rgba(255,150,50,0.15); color: var(--accent2); border: 1px solid rgba(255,150,50,0.3); }
  .rsi-pill.neutral    { background: rgba(255,255,255,0.05); color: var(--text3); border: 1px solid var(--border); }

  /* TREND */
  .trend-pill {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-family: var(--mono);
    font-size: 10px;
    font-weight: 500;
  }
  .trend-pill.up { color: var(--green); }
  .trend-pill.down { color: var(--red); }
  .trend-pill.side { color: var(--text3); }

  /* FLOW SIGNAL */
  .flow-pill {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-family: var(--mono);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.5px;
  }
  .flow-pill.inflow { color: var(--green); }
  .flow-pill.outflow { color: var(--red); }
  .flow-pill.neutral { color: var(--text3); }
  .flow-arrow { font-size: 12px; }

  /* TOP PANELS */
  .top-panels {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 16px;
    margin-bottom: 32px;
    animation: fadeUp 0.6s 0.15s ease both;
  }

  .panel {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }

  .panel-header {
    padding: 14px 16px 12px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .panel-icon { font-size: 16px; }

  .panel-title {
    font-family: var(--mono);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text2);
    font-weight: 500;
  }

  .panel-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 11px 16px;
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
  }
  .panel-item:last-child { border-bottom: none; }
  .panel-item:hover { background: rgba(255,255,255,0.02); }

  .panel-fund-name {
    font-size: 12px;
    color: var(--text);
    max-width: 160px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* MINI CHART */
  .sparkline { display: inline-block; vertical-align: middle; }

  /* SEARCH + FILTER BAR */
  .filter-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }

  .search-input {
    flex: 1;
    min-width: 200px;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 9px 14px;
    color: var(--text);
    font-family: var(--sans);
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
  }
  .search-input:focus { border-color: rgba(0,212,170,0.4); }
  .search-input::placeholder { color: var(--text3); }

  .filter-btn {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 14px;
    color: var(--text2);
    font-family: var(--mono);
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.5px;
  }
  .filter-btn:hover, .filter-btn.active {
    border-color: rgba(0,212,170,0.4);
    color: var(--accent);
    background: rgba(0,212,170,0.05);
  }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(8px);
    z-index: 200;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--bg2);
    border: 1px solid rgba(0,212,170,0.2);
    border-radius: 16px;
    width: 100%;
    max-width: 680px;
    max-height: 85vh;
    overflow-y: auto;
    animation: modalIn 0.25s ease;
  }

  @keyframes modalIn {
    from { opacity: 0; transform: scale(0.95) translateY(10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }

  .modal-header {
    padding: 24px 24px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
  }

  .modal-close {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text2);
    cursor: pointer;
    padding: 4px 10px;
    font-size: 16px;
    transition: all 0.2s;
  }
  .modal-close:hover { border-color: var(--red); color: var(--red); }

  .modal-body { padding: 24px; }

  .modal-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
  }

  .metric-box {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px;
  }
  .metric-box-label {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 6px;
  }
  .metric-box-value {
    font-family: var(--mono);
    font-size: 20px;
    font-weight: 500;
    color: var(--text);
  }

  .holdings-table { width: 100%; border-collapse: collapse; }
  .holdings-table th {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text3);
    text-align: left;
    padding: 8px 10px;
    border-bottom: 1px solid var(--border);
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .holdings-table td {
    padding: 10px 10px;
    font-size: 13px;
    border-bottom: 1px solid rgba(255,255,255,0.03);
  }

  .weight-bar {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .weight-track {
    flex: 1;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }
  .weight-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
    transition: width 0.5s ease;
  }

  /* DISCLAIMER */
  .disclaimer {
    margin-top: 48px;
    padding: 20px 24px;
    background: rgba(247,163,37,0.05);
    border: 1px solid rgba(247,163,37,0.15);
    border-radius: 10px;
    font-size: 12px;
    color: var(--text3);
    line-height: 1.7;
  }
  .disclaimer strong { color: var(--accent2); }

  /* FOOTER */
  .footer {
    margin-top: 40px;
    padding: 24px 0;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .footer-brand {
    font-family: var(--serif);
    font-size: 16px;
    font-weight: 900;
    color: var(--accent);
  }
  .footer-text {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text3);
  }

  /* LOADING */
  .loading-state {
    text-align: center;
    padding: 80px 20px;
    font-family: var(--mono);
    font-size: 13px;
    color: var(--text3);
  }
  .loading-spinner {
    width: 32px;
    height: 32px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 16px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text3);
    font-family: var(--mono);
    font-size: 12px;
  }

  @media (max-width: 900px) {
    .top-panels { grid-template-columns: 1fr; }
    .modal-grid { grid-template-columns: 1fr; }
    .header { padding: 0 16px; }
    .main { padding: 20px 12px; }
    .fund-table td:nth-child(n+7) { display: none; }
  }
</style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div class="logo">
    <span class="logo-main">FundScope</span>
    <span class="logo-sub">MY Â· Public Mutual Intelligence</span>
  </div>
  <div class="header-right">
    <div class="live-badge">
      <div class="live-dot"></div>
      DAILY DATA
    </div>
    <div class="last-updated" id="lastUpdated">Loadingâ€¦</div>
  </div>
</header>

<!-- MAIN -->
<main class="main">

  <!-- HERO -->
  <div class="hero">
    <h1>Fund <span>Intelligence</span><br>Made Clear.</h1>
    <p>RSI momentum, capital flow signals, and trend analysis for Public Mutual equity funds â€” updated every market day.</p>
  </div>

  <!-- SUMMARY STATS -->
  <div class="summary-strip" id="summaryStrip">
    <div class="stat-card blue">
      <div class="stat-label">Funds Tracked</div>
      <div class="stat-value" id="statTotal">â€”</div>
      <div class="stat-sub">Equity funds</div>
    </div>
    <div class="stat-card green">
      <div class="stat-label">Inflow Signals</div>
      <div class="stat-value" id="statInflow">â€”</div>
      <div class="stat-sub">vs category median</div>
    </div>
    <div class="stat-card orange">
      <div class="stat-label">Oversold (RSI â‰¤35)</div>
      <div class="stat-value" id="statOversold">â€”</div>
      <div class="stat-sub">Potential bounce candidates</div>
    </div>
    <div class="stat-card red">
      <div class="stat-label">Top Gainer Today</div>
      <div class="stat-value" id="statTopGainer">â€”</div>
      <div class="stat-sub" id="statTopGainerName">â€”</div>
    </div>
  </div>

  <!-- TOP PANELS: Gainers, Losers, Momentum -->
  <div class="top-panels" id="topPanels">
    <!-- Filled by JS -->
  </div>

  <!-- MAIN TABLE -->
  <div class="section-title">
    <h2>All Equity Funds</h2>
    <div class="accent-line"></div>
  </div>

  <!-- TABS -->
  <div style="display:flex; align-items:center; gap:16px; margin-bottom:16px; flex-wrap:wrap;">
    <div class="tabs">
      <button class="tab active" onclick="setSort('momentum_rank', this)">Momentum Rank</button>
      <button class="tab" onclick="setSort('pct_1d', this)">Today</button>
      <button class="tab" onclick="setSort('pct_1w', this)">1 Week</button>
      <button class="tab" onclick="setSort('pct_1m', this)">1 Month</button>
      <button class="tab" onclick="setSort('rsi_14', this)">RSI</button>
    </div>
    <div class="filter-bar" style="margin:0">
      <input class="search-input" id="searchInput" placeholder="Search fund nameâ€¦" oninput="filterFunds()">
      <button class="filter-btn" id="filterInflow" onclick="toggleFilter('inflow')">â†‘ Inflow</button>
      <button class="filter-btn" id="filterOversold" onclick="toggleFilter('oversold')">RSI â‰¤35</button>
      <button class="filter-btn" id="filterUptrend" onclick="toggleFilter('uptrend')">Uptrend</button>
    </div>
  </div>

  <div class="table-container">
    <div class="loading-state" id="tableLoading">
      <div class="loading-spinner"></div>
      Loading fund dataâ€¦
    </div>
    <table class="fund-table" id="fundTable" style="display:none">
      <thead>
        <tr>
          <th>#</th>
          <th>Fund</th>
          <th>NAV (RM)</th>
          <th onclick="setSort('pct_1d')" title="Sort by today">1D %</th>
          <th onclick="setSort('pct_1w')" title="Sort by 1 week">1W %</th>
          <th onclick="setSort('pct_1m')" title="Sort by 1 month">1M %</th>
          <th onclick="setSort('pct_3m')" title="Sort by 3 month">3M %</th>
          <th>RSI Signal</th>
          <th>Trend</th>
          <th>Flow Signal</th>
        </tr>
      </thead>
      <tbody id="fundTableBody"></tbody>
    </table>
    <div class="empty-state" id="emptyState" style="display:none">No funds match your filter.</div>
  </div>

  <!-- DISCLAIMER -->
  <div class="disclaimer">
    <strong>âš  Educational Use Only.</strong> This dashboard presents NAV-derived momentum indicators and capital flow proxies for informational purposes only. Flow signals are computed from relative NAV performance versus category median â€” not actual fund subscription/redemption data. RSI and moving averages are mathematical computations on public NAV data; they do not constitute investment advice. Past performance is not indicative of future results. Unit trust investments are subject to market risks. Always consult a licensed financial advisor before investing. This site is not affiliated with Public Mutual Berhad.
  </div>

  <footer class="footer">
    <div class="footer-brand">FundScope MY</div>
    <div class="footer-text">Data: Morningstar Â· Updated daily after market close Â· <span id="footerDate"></span></div>
  </footer>

</main>

<!-- FUND DETAIL MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal" id="modal">
    <div class="modal-header">
      <div>
        <div style="font-family:var(--mono);font-size:10px;color:var(--text3);letter-spacing:2px;text-transform:uppercase;margin-bottom:4px" id="modalCode"></div>
        <div style="font-family:var(--serif);font-size:22px;font-weight:900;color:var(--text)" id="modalName"></div>
      </div>
      <button class="modal-close" onclick="closeModalBtn()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="modal-grid" id="modalGrid"></div>
      <div style="margin-bottom:16px">
        <div style="font-family:var(--mono);font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px">Top Holdings (Quarterly Data)</div>
        <div id="modalHoldings"></div>
      </div>
      <div style="font-family:var(--mono);font-size:11px;color:var(--text3);padding:12px;background:var(--bg3);border-radius:8px;line-height:1.7" id="modalFlowNote"></div>
    </div>
  </div>
</div>

<script>
// ==========================================================================
// DATA LAYER â€” In production, this fetches from /data/dashboard.json
// For demo, we generate realistic sample data
// ==========================================================================

let allFunds = [];
let currentSort = 'momentum_rank';
let activeFilters = new Set();

// Simulate what the Python backend produces
// In production: replace with fetch('/data/dashboard.json')
function generateDemoData() {
  const fundList = [
    { code: 'PGF', name: 'Public Growth Fund' },
    { code: 'PEF', name: 'Public Equity Fund' },
    { code: 'PSCF', name: 'Public SmallCap Fund' },
    { code: 'PAGF', name: 'Public Aggressive Growth Fund' },
    { code: 'PEGF', name: 'Public Enterprises Growth Fund' },
    { code: 'PFESF', name: 'Public Far-East Select Fund' },
    { code: 'PFEDF', name: 'Public Far-East Dividend Fund' },
    { code: 'PASF', name: 'Public ASEAN Growth Fund' },
    { code: 'PAIF', name: 'Public Asia Ittikal Fund' },
    { code: 'PIEF', name: 'Public Islamic Equity Fund' },
    { code: 'PIGF', name: 'Public Islamic Growth Fund' },
    { code: 'PIOF', name: 'Public Islamic Opportunities Fund' },
    { code: 'PIDF', name: 'Public Islamic Dividend Fund' },
    { code: 'PCTF', name: 'Public China Titans Fund' },
    { code: 'PRSF2', name: 'Public Regional Sector Fund' },
    { code: 'PGSF', name: 'Public Global Select Fund' },
    { code: 'PGTF', name: 'Public Global Titans Fund' },
    { code: 'PBGF', name: 'PB Growth Fund' },
    { code: 'PBEF', name: 'PB Equity Fund' },
    { code: 'PBAEF', name: 'PB Asia Equity Fund' },
    { code: 'PSEAS', name: 'Public South-East Asia Select' },
    { code: 'PEOF', name: 'Public Emerging Opportunities' },
    { code: 'PIAG', name: 'Public Islamic ASEAN Growth' },
    { code: 'PIEEF', name: 'Public Islamic Enterprises Equity' },
    { code: 'PEIS', name: 'Public e-Islamic Sustainable' },
    { code: 'PBAPDF', name: 'PB Asia Pacific Dividend Fund' },
    { code: 'PFSF', name: 'Public Focus Select Fund' },
    { code: 'PSF', name: 'Public Savings Fund' },
    { code: 'PRSF', name: 'Public Regular Savings Fund' },
    { code: 'PIF', name: 'Public Index Fund' },
  ];

  const rsiSignals = ['OVERBOUGHT', 'BULLISH', 'NEUTRAL', 'BEARISH', 'OVERSOLD'];
  const trends = ['UPTREND', 'SIDEWAYS', 'DOWNTREND'];
  const flowSignals = ['INFLOW', 'NEUTRAL', 'OUTFLOW'];

  const sampleHoldings = [
    [
      { name: 'CIMB Group Holdings', ticker: 'CIMB', weight_pct: 8.2 },
      { name: 'Public Bank Berhad', ticker: 'PBBANK', weight_pct: 7.1 },
      { name: 'Maybank', ticker: 'MAYBANK', weight_pct: 6.8 },
      { name: 'Tenaga Nasional', ticker: 'TENAGA', weight_pct: 5.4 },
      { name: 'IHH Healthcare', ticker: 'IHH', weight_pct: 4.9 },
    ],
    [
      { name: 'Petronas Chemicals', ticker: 'PCHEM', weight_pct: 9.1 },
      { name: 'Axiata Group', ticker: 'AXIATA', weight_pct: 6.5 },
      { name: 'Hong Leong Bank', ticker: 'HLBANK', weight_pct: 5.8 },
      { name: 'Hartalega', ticker: 'HARTA', weight_pct: 4.7 },
      { name: 'Mr DIY Group', ticker: 'MRDIY', weight_pct: 4.2 },
    ],
    [
      { name: 'Alibaba Group', ticker: 'BABA', weight_pct: 7.8 },
      { name: 'Tencent Holdings', ticker: 'TCEHY', weight_pct: 7.2 },
      { name: 'Samsung Electronics', ticker: '005930', weight_pct: 6.1 },
      { name: 'Taiwan Semiconductor', ticker: 'TSM', weight_pct: 5.9 },
      { name: 'AIA Group', ticker: '1299', weight_pct: 4.3 },
    ],
  ];

  return fundList.map((f, i) => {
    const rsi = 25 + Math.random() * 55;
    const pct1d = (Math.random() - 0.45) * 1.2;
    const pct1w = (Math.random() - 0.4) * 3;
    const pct1m = (Math.random() - 0.35) * 8;
    const pct3m = (Math.random() - 0.3) * 15;
    const pct1y = (Math.random() - 0.25) * 25;
    const nav = 0.3 + Math.random() * 1.5;
    const volatility = 5 + Math.random() * 15;
    const ma20 = nav * (1 + (Math.random() - 0.5) * 0.05);
    const ma50 = nav * (1 + (Math.random() - 0.5) * 0.08);

    let rsiSignal = 'NEUTRAL';
    if (rsi >= 70) rsiSignal = 'OVERBOUGHT';
    else if (rsi <= 30) rsiSignal = 'OVERSOLD';
    else if (rsi >= 55) rsiSignal = 'BULLISH';
    else if (rsi <= 45) rsiSignal = 'BEARISH';

    let trend = 'SIDEWAYS';
    if (nav > ma20 && ma20 > ma50) trend = 'UPTREND';
    else if (nav < ma20 && ma20 < ma50) trend = 'DOWNTREND';

    const flowVsCategory = pct1m - 3.5;
    let flowSignal = 'NEUTRAL';
    if (flowVsCategory > 1.5) flowSignal = 'INFLOW';
    else if (flowVsCategory < -1.5) flowSignal = 'OUTFLOW';

    return {
      code: f.code,
      name: f.name,
      nav: parseFloat(nav.toFixed(4)),
      date: new Date().toISOString().split('T')[0],
      pct_1d: parseFloat(pct1d.toFixed(2)),
      pct_1w: parseFloat(pct1w.toFixed(2)),
      pct_1m: parseFloat(pct1m.toFixed(2)),
      pct_3m: parseFloat(pct3m.toFixed(2)),
      pct_1y: parseFloat(pct1y.toFixed(2)),
      rsi_14: parseFloat(rsi.toFixed(1)),
      rsi_signal: rsiSignal,
      ma5:  parseFloat((nav * (1 + (Math.random()-0.5)*0.02)).toFixed(4)),
      ma20: parseFloat(ma20.toFixed(4)),
      ma50: parseFloat(ma50.toFixed(4)),
      trend: trend,
      volatility: parseFloat(volatility.toFixed(1)),
      flow_signal: flowSignal,
      flow_vs_category: parseFloat(flowVsCategory.toFixed(2)),
      flow_note: `${flowVsCategory >= 0 ? '+' : ''}${flowVsCategory.toFixed(1)}% vs category median`,
      momentum_rank: i + 1,
      top_holdings: sampleHoldings[i % 3],
    };
  });
}

async function loadData() {
  try {
    // Try to fetch real data first
    const response = await fetch('./data/dashboard.json');
    if (response.ok) {
      const data = await response.json();
      return data.funds;
    }
  } catch(e) {}
  
  // Fall back to demo data
  console.log('Using demo data â€” connect your Python backend to show real NAV data');
  return generateDemoData();
}

// ==========================================================================
// RENDERING
// ==========================================================================

function pctClass(v) {
  if (v === null || v === undefined) return 'neu';
  return v > 0 ? 'pos' : v < 0 ? 'neg' : 'neu';
}

function fmtPct(v) {
  if (v === null || v === undefined) return 'â€”';
  return (v > 0 ? '+' : '') + v.toFixed(2) + '%';
}

function rsiPillClass(signal) {
  const m = { 'OVERBOUGHT': 'overbought', 'OVERSOLD': 'oversold', 'BULLISH': 'bullish', 'BEARISH': 'bearish', 'NEUTRAL': 'neutral' };
  return m[signal] || 'neutral';
}

function rsiPillIcon(signal) {
  const m = { 'OVERBOUGHT': 'â†‘â†‘', 'OVERSOLD': 'â†“â†“', 'BULLISH': 'â†‘', 'BEARISH': 'â†“', 'NEUTRAL': 'â†’' };
  return m[signal] || '?';
}

function trendClass(t) {
  if (t === 'UPTREND') return 'up';
  if (t === 'DOWNTREND') return 'down';
  return 'side';
}

function renderSummary(funds) {
  const inflow = funds.filter(f => f.flow_signal === 'INFLOW').length;
  const oversold = funds.filter(f => f.rsi_14 && f.rsi_14 <= 35).length;
  const sorted1d = [...funds].filter(f => f.pct_1d !== null).sort((a, b) => b.pct_1d - a.pct_1d);
  const topG = sorted1d[0];

  document.getElementById('statTotal').textContent = funds.length;
  document.getElementById('statInflow').textContent = inflow;
  document.getElementById('statOversold').textContent = oversold;
  if (topG) {
    document.getElementById('statTopGainer').textContent = '+' + topG.pct_1d.toFixed(2) + '%';
    document.getElementById('statTopGainerName').textContent = topG.code;
  }
}

function renderTopPanels(funds) {
  const gainers = [...funds].filter(f => f.pct_1d !== null).sort((a, b) => b.pct_1d - a.pct_1d).slice(0, 5);
  const losers = [...funds].filter(f => f.pct_1d !== null).sort((a, b) => a.pct_1d - b.pct_1d).slice(0, 5);
  const momentum = [...funds].sort((a, b) => (a.momentum_rank || 999) - (b.momentum_rank || 999)).slice(0, 5);

  function panelItems(list, field, colorFn) {
    return list.map(f => `
      <div class="panel-item" onclick="openModal('${f.code}')">
        <span class="panel-fund-name" title="${f.name}">${f.name}</span>
        <span class="pct-cell ${colorFn(f[field])}">${fmtPct(f[field])}</span>
      </div>
    `).join('');
  }

  document.getElementById('topPanels').innerHTML = `
    <div class="panel">
      <div class="panel-header"><span class="panel-icon">ðŸ“ˆ</span><span class="panel-title">Top Gainers Today</span></div>
      ${panelItems(gainers, 'pct_1d', v => v > 0 ? 'pos' : 'neg')}
    </div>
    <div class="panel">
      <div class="panel-header"><span class="panel-icon">ðŸ“‰</span><span class="panel-title">Top Losers Today</span></div>
      ${panelItems(losers, 'pct_1d', v => v > 0 ? 'pos' : 'neg')}
    </div>
    <div class="panel">
      <div class="panel-header"><span class="panel-icon">ðŸš€</span><span class="panel-title">Momentum Leaders</span></div>
      ${panelItems(momentum, 'pct_1m', v => v > 0 ? 'pos' : 'neg')}
    </div>
  `;
}

function renderTable(funds) {
  const tbody = document.getElementById('fundTableBody');
  
  if (funds.length === 0) {
    document.getElementById('emptyState').style.display = 'block';
    document.getElementById('fundTable').style.display = 'none';
    return;
  }

  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('fundTable').style.display = 'table';

  tbody.innerHTML = funds.map((f, i) => `
    <tr onclick="openModal('${f.code}')">
      <td><span class="rank-badge ${i < 3 ? 'top3' : ''}">${i + 1}</span></td>
      <td class="fund-name-cell">
        <div class="fund-name">${f.name}</div>
        <div class="fund-code">${f.code}</div>
      </td>
      <td><span class="nav-value">RM ${f.nav.toFixed(4)}</span></td>
      <td class="pct-cell ${pctClass(f.pct_1d)}">${fmtPct(f.pct_1d)}</td>
      <td class="pct-cell ${pctClass(f.pct_1w)}">${fmtPct(f.pct_1w)}</td>
      <td class="pct-cell ${pctClass(f.pct_1m)}">${fmtPct(f.pct_1m)}</td>
      <td class="pct-cell ${pctClass(f.pct_3m)}">${fmtPct(f.pct_3m)}</td>
      <td>
        <span class="rsi-pill ${rsiPillClass(f.rsi_signal)}">
          ${rsiPillIcon(f.rsi_signal)} ${f.rsi_14 ? f.rsi_14.toFixed(1) : 'â€”'}
          <span style="opacity:0.7;font-size:9px">${f.rsi_signal}</span>
        </span>
      </td>
      <td><span class="trend-pill ${trendClass(f.trend)}">${f.trend || 'N/A'}</span></td>
      <td>
        <span class="flow-pill ${f.flow_signal ? f.flow_signal.toLowerCase() : 'neutral'}">
          <span class="flow-arrow">${f.flow_signal === 'INFLOW' ? 'â†‘' : f.flow_signal === 'OUTFLOW' ? 'â†“' : 'â†’'}</span>
          ${f.flow_signal || 'N/A'}
        </span>
      </td>
    </tr>
  `).join('');
}

// ==========================================================================
// SORTING & FILTERING
// ==========================================================================

let sortDir = 1;

function setSort(field, btn) {
  if (currentSort === field) {
    sortDir *= -1;
  } else {
    sortDir = field === 'momentum_rank' ? 1 : -1;
    currentSort = field;
  }
  
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  if (btn) btn.classList.add('active');
  
  renderFiltered();
}

function toggleFilter(f) {
  if (activeFilters.has(f)) {
    activeFilters.delete(f);
    document.getElementById('filter' + f.charAt(0).toUpperCase() + f.slice(1)).classList.remove('active');
  } else {
    activeFilters.add(f);
    document.getElementById('filter' + f.charAt(0).toUpperCase() + f.slice(1)).classList.add('active');
  }
  renderFiltered();
}

function filterFunds() { renderFiltered(); }

function renderFiltered() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  
  let filtered = allFunds.filter(f => {
    if (search && !f.name.toLowerCase().includes(search) && !f.code.toLowerCase().includes(search)) return false;
    if (activeFilters.has('inflow') && f.flow_signal !== 'INFLOW') return false;
    if (activeFilters.has('oversold') && !(f.rsi_14 && f.rsi_14 <= 35)) return false;
    if (activeFilters.has('uptrend') && f.trend !== 'UPTREND') return false;
    return true;
  });

  filtered.sort((a, b) => {
    const av = a[currentSort];
    const bv = b[currentSort];
    if (av === null || av === undefined) return 1;
    if (bv === null || bv === undefined) return -1;
    return (av - bv) * sortDir;
  });

  renderTable(filtered);
}

// ==========================================================================
// MODAL
// ==========================================================================

let fundMap = {};

function openModal(code) {
  const f = fundMap[code];
  if (!f) return;

  document.getElementById('modalCode').textContent = code;
  document.getElementById('modalName').textContent = f.name;

  const metrics = [
    { label: 'NAV Price', value: `RM ${f.nav.toFixed(4)}` },
    { label: 'RSI (14)', value: f.rsi_14 ? `${f.rsi_14.toFixed(1)} â€” ${f.rsi_signal}` : 'N/A' },
    { label: '1-Month Return', value: fmtPct(f.pct_1m), color: f.pct_1m > 0 ? 'var(--green)' : 'var(--red)' },
    { label: '1-Year Return', value: fmtPct(f.pct_1y), color: f.pct_1y > 0 ? 'var(--green)' : 'var(--red)' },
    { label: 'MA20 vs MA50', value: f.ma20 && f.ma50 ? `${f.ma20.toFixed(4)} / ${f.ma50.toFixed(4)}` : 'N/A' },
    { label: 'Volatility (20D)', value: f.volatility ? `${f.volatility}%` : 'N/A' },
    { label: 'Trend', value: f.trend || 'N/A' },
    { label: 'Capital Flow Signal', value: f.flow_signal || 'N/A', color: f.flow_signal === 'INFLOW' ? 'var(--green)' : f.flow_signal === 'OUTFLOW' ? 'var(--red)' : 'inherit' },
  ];

  document.getElementById('modalGrid').innerHTML = metrics.map(m => `
    <div class="metric-box">
      <div class="metric-box-label">${m.label}</div>
      <div class="metric-box-value" style="color:${m.color || 'var(--text)'};font-size:${m.value.length > 12 ? '14px' : '18px'}">${m.value}</div>
    </div>
  `).join('');

  const holdings = f.top_holdings || [];
  if (holdings.length > 0) {
    document.getElementById('modalHoldings').innerHTML = `
      <table class="holdings-table">
        <thead><tr><th>#</th><th>Stock</th><th>Ticker</th><th>Weight</th><th></th></tr></thead>
        <tbody>
          ${holdings.map((h, i) => `
            <tr>
              <td style="color:var(--text3);font-family:var(--mono)">${i+1}</td>
              <td>${h.name}</td>
              <td style="font-family:var(--mono);font-size:11px;color:var(--text2)">${h.ticker}</td>
              <td style="font-family:var(--mono);color:var(--accent)">${h.weight_pct.toFixed(1)}%</td>
              <td style="width:100px">
                <div class="weight-bar">
                  <div class="weight-track">
                    <div class="weight-fill" style="width:${Math.min(h.weight_pct * 8, 100)}%"></div>
                  </div>
                </div>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  } else {
    document.getElementById('modalHoldings').innerHTML = `<div style="color:var(--text3);font-family:var(--mono);font-size:12px">Holdings data not available yet (fetched quarterly)</div>`;
  }

  document.getElementById('modalFlowNote').innerHTML = `
    <strong style="color:var(--accent2)">ðŸ“Š Capital Flow Analysis:</strong><br>
    ${f.flow_note || 'Flow proxy computed from relative NAV momentum vs category median.'}<br>
    <span style="font-size:10px;opacity:0.7">Note: This is a proxy signal, not actual subscription/redemption data.</span>
  `;

  document.getElementById('modalOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeModal(e) {
  if (e.target === document.getElementById('modalOverlay')) closeModalBtn();
}

function closeModalBtn() {
  document.getElementById('modalOverlay').classList.remove('open');
  document.body.style.overflow = '';
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModalBtn();
});

// ==========================================================================
// INIT
// ==========================================================================

async function init() {
  const funds = await loadData();
  allFunds = funds;
  fundMap = Object.fromEntries(funds.map(f => [f.code, f]));

  // Update header
  const now = new Date();
  document.getElementById('lastUpdated').textContent = now.toLocaleDateString('en-MY', { day:'numeric', month:'short', year:'numeric' });
  document.getElementById('footerDate').textContent = now.toLocaleDateString('en-MY', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

  renderSummary(funds);
  renderTopPanels(funds);

  // Hide loading, show table
  document.getElementById('tableLoading').style.display = 'none';
  
  renderFiltered();
}

init();
</script>
</body>
</html>
